rules_version = '2';

// Craft rules based on https://firebase.google.com/docs/storage/security/
service firebase.storage {
  match /b/{bucket}/o {
    // Allow public read access to all files
    match /{allPaths=**} {
      allow read: if true;
      
      // Allow write access only to authenticated users
      // and only to their own facility folders
      allow write: if request.auth != null 
        && request.resource.size < 5 * 1024 * 1024 // 5MB max
        && request.resource.contentType.matches('image/.*') // Only images
        && (
          // Allow writing to facilities folder with proper structure
          request.resource.name.matches('facilities/[^/]+/[^/]+') ||
          // Or allow writing directly to a facility's folder
          request.resource.name.matches('facilities/[^/]+/.+') ||
          // Allow writing to licenses folder for admins
          (request.resource.name.matches('licenses/[^/]+') && request.auth.token.role == 'admin') ||
          // Allow writing to insurances folder for admins
          (request.resource.name.matches('insurances/[^/]+') && request.auth.token.role == 'admin')
        );
    }

    // Special rules for facilities folder
    match /facilities/{facilityId}/{fileName} {
      allow read: if true;
      allow write: if request.auth != null
        && request.resource.size < 5 * 1024 * 1024
        && request.resource.contentType.matches('image/.*');
    }

    // Special rules for licenses folder
    match /licenses/{fileName} {
      allow read: if true;
      allow write: if request.auth != null
        && request.auth.token.role == 'admin'
        && request.resource.size < 5 * 1024 * 1024
        && request.resource.contentType.matches('image/.*');
    }

    // Special rules for insurances folder
    match /insurances/{fileName} {
      allow read: if true;
      allow write: if request.auth != null
        && request.auth.token.role == 'admin'
        && request.resource.size < 5 * 1024 * 1024
        && request.resource.contentType.matches('image/.*');
    }
  }
}
